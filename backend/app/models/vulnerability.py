"""Vulnerability model for tracking security issues."""

import enum
from datetime import datetime
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Enum, ForeignKey, Text, JSON, Float
from sqlalchemy.orm import relationship

from app.db.database import Base


class Severity(str, enum.Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityStatus(str, enum.Enum):
    """Vulnerability remediation status."""
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    MITIGATED = "mitigated"  # Compensating controls in place
    ACCEPTED = "accepted"  # Risk accepted
    FALSE_POSITIVE = "false_positive"


class Vulnerability(Base):
    """Vulnerability model for security findings."""
    
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # Vulnerability identification
    title = Column(String(500), nullable=False)
    description = Column(Text, nullable=True)
    
    # Severity and scoring
    severity = Column(Enum(Severity), nullable=False, index=True)
    cvss_score = Column(Float, nullable=True)  # 0.0 - 10.0
    cvss_vector = Column(String(100), nullable=True)
    
    # CVE and references
    cve_id = Column(String(50), nullable=True, index=True)  # Extended for longer CVE IDs
    cwe_id = Column(String(50), nullable=True)
    references = Column(JSON, default=list)  # List of reference URLs
    
    # Affected asset
    asset_id = Column(Integer, ForeignKey("assets.id"), nullable=False)
    asset = relationship("Asset", back_populates="vulnerabilities")
    
    # Detection info
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=True)
    scan = relationship("Scan", back_populates="vulnerabilities")
    detected_by = Column(String(100), nullable=True)  # Scanner/tool name (e.g., "nuclei")
    
    # Nuclei-specific fields
    template_id = Column(String(255), nullable=True, index=True)  # Nuclei template ID
    matcher_name = Column(String(255), nullable=True)  # Nuclei matcher name
    
    # Status tracking
    status = Column(Enum(VulnerabilityStatus), default=VulnerabilityStatus.OPEN, index=True)
    assigned_to = Column(String(255), nullable=True)
    
    # Exception tracking (for accepted/mitigated findings)
    exception_id = Column(Integer, ForeignKey("finding_exceptions.id"), nullable=True)
    exception = relationship("FindingException", back_populates="findings")
    
    # Manual finding fields
    is_manual = Column(Boolean, default=False, index=True)  # True for manual pentest findings
    impact = Column(Text, nullable=True)  # Business impact description
    affected_component = Column(String(500), nullable=True)  # Specific component affected
    steps_to_reproduce = Column(Text, nullable=True)  # Steps to reproduce the vulnerability
    
    # Evidence and remediation
    evidence = Column(Text, nullable=True)
    proof_of_concept = Column(Text, nullable=True)
    remediation = Column(Text, nullable=True)
    remediation_deadline = Column(DateTime, nullable=True)
    
    # Timestamps
    first_detected = Column(DateTime, default=datetime.utcnow)
    last_detected = Column(DateTime, default=datetime.utcnow)
    resolved_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Additional metadata (renamed to avoid SQLAlchemy conflict)
    tags = Column(JSON, default=list)
    metadata_ = Column("metadata", JSON, default=dict)
    
    def __repr__(self):
        return f"<Vulnerability {self.severity.value}: {self.title[:50]}>"
