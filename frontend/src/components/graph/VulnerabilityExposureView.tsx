'use client';

import { useEffect, useState } from 'react';
import { api } from '@/lib/api';
import { Loader2, Info } from 'lucide-react';

export interface ExposureBySource {
  source: string;
  count: number;
}

export interface ExposureData {
  total_exposure_score: number;
  total_findings: number;
  assets_with_vulnerabilities: number;
  total_assets: number;
  exposure_percentage: number;
  severity_distribution: { critical: number; high: number; medium: number; low: number };
  by_source: ExposureBySource[];
  top_vulnerable_assets: unknown[];
  exposure_trend: string;
}

const SOURCE_LABELS: Record<string, string> = {
  nuclei: 'Vuln scans (Nuclei)',
  port_scanner: 'Port exposure',
  agent: 'Agent findings',
  github_secret_scanner: 'Secret scanning',
  manual: 'Manual',
  unknown: 'Other',
};

function labelForSource(source: string): string {
  return SOURCE_LABELS[source?.toLowerCase()] ?? (source || 'Other');
}

export function VulnerabilityExposureView() {
  const [data, setData] = useState<ExposureData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;
    setLoading(true);
    setError(null);
    api
      .getVulnerabilityExposure()
      .then((res: ExposureData) => {
        if (!cancelled) setData(res);
      })
      .catch((err) => {
        if (!cancelled) setError(err?.message || 'Failed to load exposure data');
      })
      .finally(() => {
        if (!cancelled) setLoading(false);
      });
    return () => { cancelled = true; };
  }, []);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-16">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        <span className="ml-2 text-muted-foreground">Loading exposure data…</span>
      </div>
    );
  }

  if (error || !data) {
    return (
      <div className="rounded-lg border border-destructive/30 bg-destructive/5 p-4 text-destructive">
        {error || 'No exposure data available.'}
      </div>
    );
  }

  const bySource = data.by_source ?? [];
  const total = data.total_findings ?? 0;
  const strokeGreen = 'hsl(142 76% 36%)';
  const strokeCyan = '#00d4ff';

  // Layout: left column of source nodes, curves to center, center glow + number
  const svgWidth = 800;
  const svgHeight = 420;
  const centerX = 520;
  const centerY = 210;
  const leftX = 160;
  const nodeSpacing = Math.min(56, Math.max(32, (svgHeight - 80) / Math.max(1, bySource.length)));
  const startY = 80 + (svgHeight - 80 - (bySource.length - 1) * nodeSpacing) / 2;

  return (
    <div className="w-full rounded-lg border bg-card overflow-hidden">
      <div className="flex items-center justify-between px-4 py-3 border-b">
        <div className="flex items-center gap-2">
          <h3 className="font-semibold">Vulnerability Exposure</h3>
          <span className="text-muted-foreground" title="Findings by detection source flowing into total exposure">
            <Info className="h-4 w-4" />
          </span>
        </div>
      </div>
      <div className="p-2">
        <svg
          viewBox={`0 0 ${svgWidth} ${svgHeight}`}
          className="w-full h-auto min-h-[320px]"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <filter id="vuln-exposure-glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur" />
              <feMerge>
                <feMergeNode in="blur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>

          {/* Curved paths from each source node to center */}
          {bySource.map((item, i) => {
            const y = startY + i * nodeSpacing;
            const ctrlX = (leftX + centerX) / 2 + 40;
            const ctrlY = (y + centerY) / 2;
            const pathD = `M ${leftX} ${y} Q ${ctrlX} ${ctrlY} ${centerX} ${centerY}`;
            return (
              <path
                key={item.source}
                d={pathD}
                fill="none"
                stroke={strokeGreen}
                strokeWidth="1"
                opacity="0.35"
              />
            );
          })}

          {/* Left column: source labels + circles */}
          {bySource.map((item, i) => {
            const y = startY + i * nodeSpacing;
            return (
              <g key={item.source}>
                <circle
                  cx={leftX}
                  cy={y}
                  r="6"
                  fill={strokeGreen}
                  filter="url(#vuln-exposure-glow)"
                />
                <text
                  x={leftX - 10}
                  y={y}
                  textAnchor="end"
                  dominantBaseline="middle"
                  fill="hsl(var(--foreground))"
                  style={{ fontSize: 12, fontFamily: 'var(--font-sans), system-ui, sans-serif' }}
                >
                  {labelForSource(item.source)}
                </text>
                <text
                  x={leftX - 10}
                  y={y + 14}
                  textAnchor="end"
                  dominantBaseline="middle"
                  fill="hsl(var(--muted-foreground))"
                  style={{ fontSize: 10 }}
                >
                  {item.count.toLocaleString()}
                </text>
              </g>
            );
          })}

          {/* Center: concentric rings + total */}
          <g className="vuln-exposure-central">
            {[110, 100, 90, 80].map((r, i) => (
              <circle
                key={r}
                cx={centerX}
                cy={centerY}
                r={r}
                fill="none"
                stroke={strokeCyan}
                strokeWidth="0.5"
                opacity={0.1 - i * 0.02}
                filter="url(#vuln-exposure-glow)"
                className="threat-exposure-rotate"
              />
            ))}
            <circle
              cx={centerX}
              cy={centerY}
              r={77.5}
              fill="none"
              stroke={strokeGreen}
              strokeWidth="2"
              opacity={0.79}
              filter="url(#vuln-exposure-glow)"
            />
            <text
              x={centerX}
              y={centerY}
              textAnchor="middle"
              dominantBaseline="middle"
              fill="hsl(var(--foreground))"
              style={{ fontSize: 28, fontWeight: 'normal', fontFamily: 'var(--font-sans), system-ui, sans-serif' }}
            >
              {total.toLocaleString()}
            </text>
            <text
              x={centerX}
              y={centerY + 100}
              textAnchor="middle"
              fill={strokeGreen}
              style={{ fontSize: 12, fontWeight: 600, letterSpacing: '0.5px' }}
            >
              Open findings
            </text>
          </g>
        </svg>
      </div>
      <div className="px-4 py-2 border-t text-xs text-muted-foreground flex flex-wrap gap-4">
        <span>Assets with findings: {data.assets_with_vulnerabilities?.toLocaleString() ?? 0}</span>
        <span>Exposure score: {data.total_exposure_score?.toLocaleString() ?? 0}</span>
        <span>Trend: {data.exposure_trend ?? '—'}</span>
      </div>
    </div>
  );
}
